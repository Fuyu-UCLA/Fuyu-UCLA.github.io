---
layout: post
title:  "Homework 2"
categories: blog assignment
---

```python
# import pandas to read datas, sqlite3 to controll datas
import pandas as pd
import sqlite3

# read datas and put it into pd
temps = pd.read_csv("temps_stacked.csv")
countries = pd.read_csv("countries.csv")

# whitespaces in column names are bad for SQL
countries = countries.rename(columns= {"FIPS 10-4": "FIPS"})

# read datas from internet
url = "https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/noaa-ghcn/station-metadata.csv"
stations = pd.read_csv(url)
```

```python
# create a database named temps.db
conn = sqlite3.connect("temps.db")

# create three data tables
temps.to_sql("temperatures", conn, if_exists="replace", index=False)
countries.to_sql("countries", conn, if_exists="replace", index=False)
stations.to_sql("stations", conn, if_exists="replace", index=False)

# don't forget close connection after using
conn.close()
```

```python
def query_climate_database(country, year_begin, year_end, month):
    conn = sqlite3.connect("temps.db")
    
    cmd = f"""
    SELECT S.name, S.latitude, S.longitude, C.name, T.year, T.month, T.temp
    FROM countries C
    LEFT JOIN temperatures T, stations S ON (S.id = T.id) AND (SUBSTRING(S.id, 1, 2) = C.FIPS)
    WHERE (C.name = '{country}') AND (T.year BETWEEN {year_begin} AND {year_end}) AND (T.month = {month})
    """
    df = pd.read_sql(cmd, conn)
    conn.close()
    
    return df
```

```python
query_climate_database(country = "India", 
                       year_begin = 1980, 
                       year_end = 2020,
                       month = 1)
```

```python
import plotly.express as px
from sklearn.linear_model import LinearRegression

def temperature_coefficient_plot(country, year_begin, year_end, 
                                 month, min_obs, **kwargs):
    return px.density_mapbox(
        query_climate_database(country, year_begin, year_end, month),
        lat = "LATITUDE",
        lon = "LONGITUDE", 
        hover_name = "NAME",
        zoom = zoom,
        mapbox_style = mapbox_style,
        color_continuous_scale = color_continuous_scale,
        radius = 3,
        title = f"Estimates yearly increases in temperature during {month} for station in {country}, years{year_begin}-{year_end}"
    )
    
```
```python
# assumes you have imported necessary packages
color_map = px.colors.diverging.RdGy_r # choose a colormap

fig = temperature_coefficient_plot("India", 1980, 2020, 1, 
                                   min_obs = 10,
                                   zoom = 2,
                                   mapbox_style="carto-positron",
                                   color_continuous_scale=color_map)

fig.show()
```